<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Durak Premium</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            background-color: #35654d;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }

        #bot-area { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        #table-area { flex: 2; position: relative; z-index: 5; }
        #drop-zone { position: absolute; width: 100%; height: 100%; z-index: 0; }
        #my-area { height: 260px; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 10px; position: relative; z-index: 20; }

        /* –ö–ê–†–¢–ê –°–¢–ò–õ–Ü */
        .card {
            width: 80px; height: 120px;
            background-color: white; border-radius: 6px;
            box-shadow: 1px 2px 5px rgba(0,0,0,0.5);
            position: absolute;
            background-size: 100% 100%;
            background-repeat: no-repeat;
            /* –ê–Ω–∏–º–∞—Ü–∏—è–ª–∞—Ä */
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), left 0.3s, top 0.3s;
        }

        /* –ê–ù–ò–ú–ê–¶–ò–Ø: –ö–æ–ª–æ–¥–∞–¥–∞–Ω –∫–µ–ª—É */
        @keyframes flyFromDeck {
            from { transform: translate(-300px, -300px) scale(0.5); opacity: 0; }
            to { transform: translate(0, 0) scale(1); opacity: 1; }
        }
        .animate-draw { animation: flyFromDeck 0.5s ease-out forwards; }

        /* –ê–ù–ò–ú–ê–¶–ò–Ø: “Æ—Å—Ç–µ–ª–≥–µ —Ç“Ø—Å—É */
        @keyframes landOnTable {
            from { transform: scale(1.2); opacity: 0.5; }
            to { transform: scale(0.85); opacity: 1; }
        }
        
        .card-back {
            background-image: url('/cards/back.png'); 
            background-size: cover; border: 1px solid #999;
        }

        /* –°“Ø–π—Ä–µ—É */
        .card.dragging {
            z-index: 9999 !important;
            transition: none !important;
            transform: scale(1.15) !important;
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
        }

        /* “Æ—Å—Ç–µ–ª–¥–µ–≥—ñ –∫–∞—Ä—Ç–∞–ª–∞—Ä (–ö—ñ—à—ñ—Ä–µ–π—Ç—É) */
        .table-pair { 
            position: relative; width: 80px; height: 120px; margin: 10px; 
            transform: scale(0.85); /* –ö–Ü–®–Ü–†–ï–ô–¢–£ */
        }
        .card-attack { position: absolute !important; transform: rotate(-2deg) !important; z-index: 1; left: 0; top: 0;}
        .card-defend { position: absolute !important; z-index: 5; transform: translate3d(20px, 15px, 0) rotate(10deg) !important; box-shadow: 2px 5px 15px rgba(0,0,0,0.5); left: 0; top: 0;}

        /* –ë–∞—Ç—ã—Ä–º–∞–ª–∞—Ä */
        .controls { position: absolute; bottom: 160px; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 100; pointer-events: none;}
        .btn { 
            pointer-events: auto;
            padding: 12px 30px; border: none; border-radius: 25px; 
            font-size: 16px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); text-transform: uppercase;
        }
        .btn-take { background: #ffcc00; color: black; }
        .btn-bita { background: #cc0000; color: white; }
        
        #slots-container {
            display: flex; justify-content: center; align-items: center; height: 100%; width: 100%; flex-wrap: wrap; pointer-events: none;
        }

        #deck-area { position: absolute; left: 20px; top: 45%; width: 90px; height: 120px; }
        #deck-count { position: absolute; left: 0; top: 0; z-index: 2; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; font-size: 20px; text-shadow: 1px 1px 2px black;}
        #trump-container { position: absolute; left: 20px; top: 10px; z-index: 1; transform: rotate(90deg); filter: brightness(0.9); }

        #status-msg {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6); color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold;
            z-index: 50; display: none;
        }
    </style>
</head>
<body>

    <div id="status-msg"></div>

    <div id="bot-area">
        <div id="deck-area">
            <div id="trump-container"></div>
            <div class="card card-back" id="deck-count">36</div>
        </div>
        <div id="bot-hand" style="display:flex; justify-content:center;"></div>
    </div>

    <div id="table-area">
        <div id="drop-zone"></div>
        <div id="slots-container"></div>
    </div>

    <div id="my-area">
        <div class="controls">
            <button class="btn btn-take" onclick="socket.emit('actionTake')">–ê–õ–£</button>
            <button class="btn btn-bita" onclick="socket.emit('actionBita')">–ë–ò–¢–ê</button>
        </div>
        <div id="my-hand" style="display:flex; justify-content:center; align-items:flex-end; height:100%; padding-bottom:10px;"></div>
    </div>

    <script>
        const socket = io();
        const myHandDiv = document.getElementById('my-hand');
        const botHandDiv = document.getElementById('bot-hand');
        const slotsContainer = document.getElementById('slots-container');
        const dropZone = document.getElementById('drop-zone');
        const trumpContainer = document.getElementById('trump-container');
        const deckCountDiv = document.getElementById('deck-count');
        const statusMsg = document.getElementById('status-msg');

        // –°–£–†–ï–¢–¢–ï–†–î–Ü –ê–õ–£
        function getCardImage(card) {
            const suitCodes = {'‚ô•': 'h', '‚ô¶': 'd', '‚ô£': 'c', '‚ô†': 's'};
            const valCodes = {'J':'j', 'Q':'q', 'K':'k', 'A':'a'};
            const s = suitCodes[card.suit];
            const v = valCodes[card.value] || card.value;
            return `/cards/${v}${s}.png`;
        }

        // –ö–ê–†–¢–ê –ñ–ê–°–ê–£ (–´“í–´–°–£ + –ê–ù–ò–ú–ê–¶–ò–Ø)
        function createCardElement(card, isFaceUp, index, total, isHand, originalIndex) {
            const el = document.createElement('div');
            el.className = 'card';
            
            if (!isFaceUp) {
                el.classList.add('card-back');
                if(!isHand) el.style.margin = '0 -45px'; 
                el.style.position = 'relative';
            } else {
                const imgUrl = getCardImage(card);
                el.style.backgroundImage = `url('${imgUrl}')`;
                
                if(isHand) {
                    el.style.position = 'relative';
                    el.style.bottom = '0px'; 
                    el.style.zIndex = index;
                    // üî• –ê–ù–ò–ú–ê–¶–ò–Ø: –ö–æ–ª–æ–¥–∞–¥–∞–Ω “±—à—ã–ø –∫–µ–ª—É (—Ç–µ–∫ –∂–∞“£–∞ –±–æ–ª—Å–∞) üî•
                    el.classList.add('animate-draw');

                    // --- –°–ú–ê–†–¢ –´“í–´–°–£ (SQUEEZE) ---
                    let overlap = -35; // –°—Ç–∞–Ω–¥–∞—Ä—Ç—Ç—ã –∂–∞–±—ã—Å—É
                    // –ï–≥–µ—Ä –∫–∞—Ä—Ç–∞ –∫”©–ø –±–æ–ª—Å–∞, “õ–∞—Ç—Ç—ã—Ä–∞“õ “õ—ã—Å–∞–º—ã–∑
                    if (total > 5) overlap = -50;
                    if (total > 8) overlap = -60;
                    
                    el.style.margin = `0 ${overlap}px`;

                    // --- –°“Æ–ô–†–ï–£ ---
                    let startX, startY;
                    
                    el.addEventListener('touchstart', (e) => {
                        e.preventDefault(); 
                        const touch = e.touches[0];
                        const rect = el.getBoundingClientRect();
                        el.classList.add('dragging');
                        el.style.position = 'fixed';
                        el.style.left = rect.left + 'px';
                        el.style.top = rect.top + 'px';
                        el.style.margin = '0';
                        el.style.animation = 'none'; // –°“Ø–π—Ä–µ–≥–µ–Ω–¥–µ –∞–Ω–∏–º–∞—Ü–∏—è–Ω—ã ”©—à—ñ—Ä—É
                        startX = touch.clientX;
                        startY = touch.clientY;
                        el.dataset.origLeft = rect.left;
                        el.dataset.origTop = rect.top;
                    }, {passive: false});

                    el.addEventListener('touchmove', (e) => {
                        e.preventDefault();
                        const touch = e.touches[0];
                        const dx = touch.clientX - startX;
                        const dy = touch.clientY - startY;
                        el.style.left = (parseFloat(el.dataset.origLeft) + dx) + 'px';
                        el.style.top = (parseFloat(el.dataset.origTop) + dy) + 'px';
                    }, {passive: false});

                    el.addEventListener('touchend', (e) => {
                        el.classList.remove('dragging');
                        const rect = el.getBoundingClientRect();
                        const tableRect = document.getElementById('table-area').getBoundingClientRect();

                        if (rect.top < tableRect.bottom && rect.bottom > tableRect.top) {
                            socket.emit('playCard', originalIndex);
                            el.style.display = 'none'; 
                        } else {
                            // –û—Ä–Ω—ã–Ω–∞ “õ–∞–π—Ç—É
                            el.style.position = 'relative';
                            el.style.left = '';
                            el.style.top = '';
                            el.style.margin = `0 ${overlap}px`;
                        }
                    });
                } else {
                    el.style.position = 'absolute'; 
                }
            }
            return el;
        }

        socket.on('updateState', (state) => {
            if(state.winner) {
                statusMsg.innerText = state.winner === 'player' ? "–ñ–ï“¢–Ü–°!" : "–ñ–ï“¢–Ü–õ–Ü–°";
                statusMsg.style.display = 'block';
            } else if(state.attacker === 'player') {
                statusMsg.innerText = "–°–µ–Ω—ñ“£ –∫–µ–∑–µ–≥—ñ“£";
                statusMsg.style.display = 'block';
            } else {
                statusMsg.style.display = 'none';
            }

            const sortedHand = state.playerHand.map((card, idx) => ({...card, originalIndex: idx}))
                .sort((a, b) => {
                    const isATrump = a.suit === state.trumpCard.suit;
                    const isBTrump = b.suit === state.trumpCard.suit;
                    const power = {'6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14};
                    if (isATrump && !isBTrump) return 1;
                    if (!isATrump && isBTrump) return -1;
                    if (a.suit === b.suit) return power[a.value] - power[b.value];
                    return a.suit.localeCompare(b.suit);
                });

            myHandDiv.innerHTML = '';
            sortedHand.forEach((c, i) => {
                myHandDiv.appendChild(createCardElement(c, true, i, sortedHand.length, true, c.originalIndex));
            });

            botHandDiv.innerHTML = '';
            for(let i=0; i<state.botCardCount; i++) {
                botHandDiv.appendChild(createCardElement(null, false, i, state.botCardCount, false));
            }

            slotsContainer.innerHTML = '';
            for (let i = 0; i < state.table.length; i += 2) {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'table-pair';
                
                const attackCard = state.table[i].card;
                const attackEl = createCardElement(attackCard, true, 0,0,false);
                attackEl.classList.add('card-attack'); 
                // “Æ—Å—Ç–µ–ª–≥–µ —Ç“Ø—Å–∫–µ–Ω–¥–µ –∞–Ω–∏–º–∞—Ü–∏—è
                attackEl.style.animation = 'landOnTable 0.3s ease-out';
                pairDiv.appendChild(attackEl);

                if (state.table[i+1]) {
                    const defendCard = state.table[i+1].card;
                    const defendEl = createCardElement(defendCard, true, 0,0,false);
                    defendEl.classList.add('card-defend'); 
                    defendEl.style.animation = 'landOnTable 0.3s ease-out';
                    pairDiv.appendChild(defendEl);
                }
                slotsContainer.appendChild(pairDiv);
            }

            trumpContainer.innerHTML = '';
            if (state.trumpCard) {
                const tCard = createCardElement(state.trumpCard, true, 0,0,false);
                tCard.style.position = 'relative';
                tCard.style.transform = 'none';
                tCard.style.margin = '0';
                trumpContainer.appendChild(tCard);
            }
            deckCountDiv.innerText = state.deckCount;
            if(state.deckCount === 0) deckCountDiv.style.opacity = 0;
        });
        
        socket.on('message', (msg) => {
            statusMsg.innerText = msg;
            statusMsg.style.display = 'block';
            setTimeout(() => statusMsg.style.display = 'none', 1500);
        });
    </script>
</body>
</html>
