<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Durak Sprite</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            background: radial-gradient(circle, #1e5631 0%, #0e2f17 100%);
            color: white;
            font-family: sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        #bot-area { height: 120px; display: flex; justify-content: center; align-items: center; position: relative; }
        #table-area { flex: 1; display: flex; justify-content: center; align-items: center; perspective: 800px; }
        #my-area { height: 220px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 20px; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); }
        #my-hand { position: relative; width: 100%; height: 150px; display: flex; justify-content: center; align-items: flex-end; }

        /* –ö–ê–†–¢–ê –î–ò–ó–ê–ô–ù–´ */
        .card {
            width: 85px;
            height: 125px;
            border-radius: 6px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.6);
            position: absolute;
            transition: transform 0.2s;
            transform-origin: bottom center;
            background-color: white;
            
            /* –°–£–†–ï–¢–¢–Ü “ö–û–°–£ */
            background-image: url('/cards/deck.png');
            background-repeat: no-repeat;
            /* 13 –±–∞“ì–∞–Ω–∞, 4 “õ–∞—Ç–∞—Ä –¥–µ–ø –µ—Å–µ–ø—Ç–µ–π–º—ñ–∑ */
            background-size: 1300% 400%; 
        }

        .card-back {
            /* –ê—Ä—Ç“õ—ã –∂–∞“ì—ã–Ω–∞ “õ—ã–∑—ã–ª ”©—Ä–Ω–µ–∫ */
            background-image: none;
            background: repeating-linear-gradient(45deg, #b71c1c, #b71c1c 10px, #922b21 10px, #922b21 20px);
            border: 2px solid white;
        }

        .table-card { position: relative !important; transform: none !important; margin: 0 5px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .my-card:hover { z-index: 100 !important; transform: translateY(-50px) scale(1.15) !important; cursor: pointer; }

        /* –ë–∞—Ç—ã—Ä–º–∞–ª–∞—Ä */
        .controls { z-index: 1000; margin-bottom: 20px; display: flex; gap: 15px; }
        .btn { padding: 12px 30px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; }
        .btn-take { background: gold; } .btn-bita { background: crimson; color: white; } .btn-restart { background: skyblue; }
        #status-text { text-align: center; font-size: 18px; margin-top: 10px; text-shadow: 1px 1px 2px black; }
    </style>
</head>
<body>

    <div id="bot-area">
        <div style="position: absolute; left: 15px;">
            <div id="deck-count" class="card card-back" style="position: relative; display:flex; align-items:center; justify-content:center; color:white; font-size:24px;">36</div>
        </div>
        <div id="trump-placeholder" style="position: absolute; left: 30px; z-index: -1;"></div>
        <div id="bot-hand" style="display:flex;"></div>
    </div>

    <div id="status-text">...</div>
    <div id="table-area"></div>

    <div id="my-area">
        <div class="controls">
            <button class="btn btn-take" onclick="socket.emit('actionTake')">–ê–õ–£</button>
            <button class="btn btn-bita" onclick="socket.emit('actionBita')">–ë–ò–¢–ê</button>
            <button class="btn btn-restart" onclick="socket.emit('restart')">‚Üª</button>
        </div>
        <div id="my-hand"></div>
    </div>

    <script>
        const socket = io();
        const myHandDiv = document.getElementById('my-hand');
        const botHandDiv = document.getElementById('bot-hand');
        const tableDiv = document.getElementById('table-area');
        const trumpDiv = document.getElementById('trump-placeholder');
        const statusDiv = document.getElementById('status-text');
        const deckCountDiv = document.getElementById('deck-count');

        // –°–£–†–ï–¢–¢–Ü “ö–ò–Æ –§–£–ù–ö–¶–ò–Ø–°–´
        function setCardBackground(el, card) {
            // –ú–∞—Å—Ç—å—Ç–∞—Ä (–°—É—Ä–µ—Ç—ñ“£–µ “õ–∞—Ä–∞–ø —Ä–µ—Ç—Ç–µ—É –∫–µ—Ä–µ–∫)
            // 0: ‚ô•, 1: ‚ô¶, 2: ‚ô£, 3: ‚ô† (–ë“±–ª —Å—Ç–∞–Ω–¥–∞—Ä—Ç, –µ–≥–µ—Ä —Å—É—Ä–µ—Ç—Ç–µ –±–∞—Å“õ–∞—à–∞ –±–æ–ª—Å–∞, –∞—É—ã—Å—Ç—ã—Ä)
            const suitRows = { '‚ô•': 0, '‚ô¶': 1, '‚ô£': 2, '‚ô†': 3 };

            // –°–∞–Ω–¥–∞—Ä (A-–¥–∞–Ω K-“ì–∞ –¥–µ–π—ñ–Ω)
            const valueCols = {
                'A': 0, '2': 1, '3': 2, '4': 3, '5': 4, 
                '6': 5, '7': 6, '8': 7, '9': 8, '10': 9, 
                'J': 10, 'Q': 11, 'K': 12
            };

            const col = valueCols[card.value] || 0;
            const row = suitRows[card.suit] || 0;

            const xPos = (col * (100 / 12)).toFixed(4);
            const yPos = (row * (100 / 3)).toFixed(4);

            el.style.backgroundPosition = `${xPos}% ${yPos}%`;
        }

        function createCard(card, isFaceUp, index, total, isHand) {
            const el = document.createElement('div');
            el.className = 'card';

            if (!isFaceUp) {
                el.classList.add('card-back');
                if(!isHand) el.style.margin = '0 -35px';
            } else {
                setCardBackground(el, card);
                // –°–∞“õ—Ç–∞–Ω–¥—ã—Ä—É (–µ–≥–µ—Ä —Å—É—Ä–µ—Ç –∂“Ø–∫—Ç–µ–ª–º–µ—Å–µ, ”ô—Ä—ñ–ø –∫”©—Ä—ñ–Ω—ñ–ø —Ç“±—Ä–∞–¥—ã)
                el.innerHTML = `<span style="position:absolute; top:2px; left:2px; color:black; font-size:10px;">${card.value}${card.suit}</span>`;
            }

            if (isHand && isFaceUp) {
                el.classList.add('my-card');
                const center = (total - 1) / 2;
                const angle = (index - center) * 5;
                const yOffset = Math.abs(index - center) * 8;
                const xOffset = (index - center) * 40;
                el.style.transform = `translateX(${xOffset}px) translateY(${yOffset}px) rotate(${angle}deg)`;
                el.style.zIndex = index;
                el.onclick = () => socket.emit('playCard', index);
            } else if (!isHand && isFaceUp) {
                el.classList.add('table-card');
            }
            return el;
        }

        socket.on('updateState', (state) => {
            if(state.winner) statusDiv.innerText = state.winner === 'player' ? "üéâ –ñ–ï“¢–Ü–°!" : "ü§ñ –ë–û–¢ –ñ–ï“¢–î–Ü!";
            else statusDiv.innerText = state.attacker === 'player' ? "‚öîÔ∏è –°–µ–Ω—ñ“£ –∂“Ø—Ä—ñ—Å—ñ“£" : "üõ°Ô∏è “ö–æ—Ä“ì–∞–Ω";

            myHandDiv.innerHTML = '';
            state.playerHand.forEach((c, i) => myHandDiv.appendChild(createCard(c, true, i, state.playerHand.length, true)));

            botHandDiv.innerHTML = '';
            for(let i=0; i<state.botCardCount; i++) botHandDiv.appendChild(createCard(null, false));

            tableDiv.innerHTML = '';
            state.table.forEach(t => tableDiv.appendChild(createCard(t.card, true)));

            trumpDiv.innerHTML = '';
            if (state.trumpCard) {
                const tCard = createCard(state.trumpCard, true);
                tCard.style.transform = 'rotate(90deg) translateX(30px)';
                tCard.style.zIndex = -1;
                trumpDiv.appendChild(tCard);
            }
            deckCountDiv.innerText = state.deckCount || "";
            deckCountDiv.style.opacity = state.deckCount > 0 ? 1 : 0;
        });
    </script>
</body>
</html>
