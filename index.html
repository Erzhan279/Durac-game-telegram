<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Durak Pro Animation</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            /* ”ò–¥–µ–º—ñ –∂–∞—Å—ã–ª –≥—Ä–∞–¥–∏–µ–Ω—Ç */
            background: radial-gradient(circle at 50% 30%, #1e6028 0%, #0a2910 100%);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        /* --- –ê–ô–ú–ê“ö–¢–ê–† --- */
        #bot-area { height: 120px; position: relative; z-index: 1; width: 100%;}
        #table-area { 
            flex: 1; 
            position: relative; 
            z-index: 5; 
            display: flex; 
            justify-content: center; 
            align-items: center;
        }
        
        #my-area { 
            height: 280px; 
            display: flex; 
            flex-direction: column; 
            justify-content: flex-end; 
            align-items: center; 
            padding-bottom: 10px; 
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); 
            z-index: 20;
            position: relative;
        }
        
        /* –ú–µ–Ω—ñ“£ “õ–æ–ª—ã–º - –µ–Ω–¥—ñ –∫–∞—Ä—Ç–∞–ª–∞—Ä absolute –µ–º–µ—Å, –æ—Å—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —ñ—à—ñ–Ω–¥–µ –±–∞—Å“õ–∞—Ä—ã–ª–∞–¥—ã */
        #my-hand { 
            position: relative; 
            width: 100%; 
            height: 100%; 
        }

        /* --- –ö–ê–†–¢–ê –î–ò–ó–ê–ô–ù–´ --- */
        .card {
            width: 90px;
            height: 135px;
            background: #fff;
            border-radius: 10px;
            position: absolute; /* –ë–∞—Ä–ª—ã“õ –∫–∞—Ä—Ç–∞ absolute –±–æ–ª–∞–¥—ã */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 6px;
            box-sizing: border-box;
            border: 1px solid #999;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            
            /* –ú–ê“¢–´–ó–î–´: –ë–∞—Ä–ª—ã“õ “õ–æ–∑“ì–∞–ª—ã—Å“õ–∞ –∞–Ω–∏–º–∞—Ü–∏—è “õ–æ—Å—É */
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), top 0.4s, left 0.4s, opacity 0.3s;
            will-change: transform, top, left;
            z-index: 10;
        }

        /* “Æ—Å—Ç–µ–ª–¥–µ–≥—ñ –∫–∞—Ä—Ç–∞–ª–∞—Ä –∫—ñ—à—ñ—Ä–µ–∫ –±–æ–ª—É—ã –∫–µ—Ä–µ–∫ */
        .card.on-table {
            transform: scale(0.75) !important; /* –î”ô—É –∫–∞—Ä—Ç–∞–ª–∞—Ä–¥—ã –∫—ñ—à—ñ—Ä–µ–π—Ç–µ–¥—ñ */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* –ö–∞—Ä—Ç–∞ —ñ—à—ñ */
        .red { color: #d32f2f; }
        .black { color: #212121; }
        .val-top { font-size: 20px; font-weight: 800; line-height: 1; }
        .suit-big { font-size: 50px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .val-bot { font-size: 20px; font-weight: 800; line-height: 1; transform: rotate(180deg); }

        .card-back {
            background: repeating-linear-gradient(135deg, #b71c1c, #b71c1c 10px, #880e4f 10px, #880e4f 20px);
            border: 2px solid #fff;
        }
        .card-back * { display: none; }

        /* –°“Ø–π—Ä–µ—É –∫–µ–∑—ñ–Ω–¥–µ */
        .card.dragging {
            transition: none !important; /* –°“Ø–π—Ä–µ–≥–µ–Ω–¥–µ –∫–µ—à—ñ–≥—É –±–æ–ª–º–∞—É –∫–µ—Ä–µ–∫ */
            z-index: 9999 !important;
            transform: scale(1.1) !important;
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
        }

        /* –ë–∞—Ç—ã—Ä–º–∞–ª–∞—Ä */
        .controls { z-index: 1000; margin-bottom: 20px; display: flex; gap: 20px; }
        .btn { padding: 12px 40px; border-radius: 30px; border: none; font-weight: 800; cursor: pointer; text-transform: uppercase; box-shadow: 0 5px 15px rgba(0,0,0,0.4); transition: 0.1s;}
        .btn:active { transform: scale(0.95); }
        .btn-take { background: linear-gradient(#ffca28, #ff6f00); color: #3e2723; }
        .btn-bita { background: linear-gradient(#e53935, #b71c1c); color: white; }

        /* –ö–æ–ª–æ–¥–∞ –∂”ô–Ω–µ –ö–æ–∑—ã—Ä—å */
        #deck-container {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 100px; 
            height: 140px;
        }
        #deck-count {
            position: absolute; left: 0; top: 0; z-index: 2;
            display: flex; justify-content: center; align-items: center;
            color: white; font-size: 24px; font-weight: bold; text-shadow: 1px 1px 2px black;
        }
        #trump-card {
            position: absolute; left: 20px; top: 0; z-index: 0;
            transform: rotate(90deg);
            filter: brightness(0.8);
        }

        #status-pill {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 10px;
            font-size: 18px; display: none; pointer-events: none; z-index: 9999;
        }

        /* –û–π—ã–Ω—à—ã —Å—Ç–∞—Ç—É—Å—ã (–ö–µ–∑–µ–≥—ñ –∫—ñ–º–Ω—ñ“£) */
        #game-info {
            position: absolute; top: 10px; right: 20px; 
            text-align: right; color: rgba(255,255,255,0.7); font-size: 14px;
        }
    </style>
</head>
<body>

    <div id="deck-container">
        <div id="trump-card"></div> <div class="card card-back" id="deck-count">36</div>
    </div>

    <div id="game-info">–ö“Ø—Ç—É...</div>
    <div id="status-pill"></div>

    <div id="bot-area"></div>

    <div id="table-area"></div>

    <div id="my-area">
        <div class="controls">
            <button class="btn btn-take" onclick="takeAction()">–ê–õ–£</button>
            <button class="btn btn-bita" onclick="bitaAction()">–ë–ò–¢–ê</button>
        </div>
        <div id="my-hand"></div>
    </div>

    <script>
        const socket = io();
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—Ç–µ—Ä—ñ
        const els = {
            myHand: document.getElementById('my-hand'),
            table: document.getElementById('table-area'),
            deck: document.getElementById('deck-container'),
            trump: document.getElementById('trump-card'),
            deckCount: document.getElementById('deck-count'),
            gameInfo: document.getElementById('game-info'),
            status: document.getElementById('status-pill'),
            botArea: document.getElementById('bot-area')
        };

        // –õ–æ–∫–∞–ª—å–¥—ñ –∂–∞–¥ (–∞–Ω–∏–º–∞—Ü–∏—è –¥“±—Ä—ã—Å –∂“Ø—Ä—É—ñ “Ø—à—ñ–Ω –µ—Å–∫—ñ –∫–∞—Ä—Ç–∞–ª–∞—Ä–¥—ã –µ—Å—Ç–µ —Å–∞“õ—Ç–∞–π–º—ã–∑)
        let myCardsMap = new Map(); // –ú–µ–Ω—ñ“£ “õ–æ–ª—ã–º–¥–∞“ì—ã –∫–∞—Ä—Ç–∞–ª–∞—Ä (id -> element)
        let tableCardsMap = new Map(); // “Æ—Å—Ç–µ–ª–¥–µ–≥—ñ –∫–∞—Ä—Ç–∞–ª–∞—Ä
        
        // –ö–∞—Ä—Ç–∞–Ω—ã“£ –±—ñ—Ä–µ–≥–µ–π ID-—Å—ã–Ω –∂–∞—Å–∞—É (Suit + Value)
        const getCardId = (c) => c ? `${c.suit}-${c.value}` : 'unknown';

        // 1. HTML –ì–ï–ù–ï–†–ê–¶–ò–Ø
        function getCardHTML(card) {
            const isRed = (card.suit === '‚ô•' || card.suit === '‚ô¶');
            const colorClass = isRed ? 'red' : 'black';
            return `
                <div class="val-top ${colorClass}">${card.value}<br>${card.suit}</div>
                <div class="suit-big ${colorClass}">${card.suit}</div>
                <div class="val-bot ${colorClass}">${card.value}<br>${card.suit}</div>
            `;
        }

        // 2. –ö–ê–†–¢–ê–ù–´ –ñ–ê–°–ê–£ –ñ”ò–ù–ï “ö–û–ó“í–ê–õ–¢–£
        function updateMyHand(cards, trumpSuit) {
            // –ö–∞—Ä—Ç–∞–ª–∞—Ä–¥—ã —Å“±—Ä—ã–ø—Ç–∞—É (–ö–æ–∑—ã—Ä—å –æ“£ –∂–∞“õ—Ç–∞)
            const sorted = [...cards].sort((a, b) => {
                const isATrump = a.suit === trumpSuit;
                const isBTrump = b.suit === trumpSuit;
                const power = {'6':6, '7':7, '8':8, '9':9, '10':10, 'J':11, 'Q':12, 'K':13, 'A':14};
                if (isATrump && !isBTrump) return 1;
                if (!isATrump && isBTrump) return -1;
                if (a.suit === b.suit) return power[a.value] - power[b.value];
                return a.suit.localeCompare(b.suit);
            });

            const newIds = new Set(sorted.map(getCardId));

            // –ê. –ñ–æ“õ –±–æ–ª“ì–∞–Ω –∫–∞—Ä—Ç–∞–ª–∞—Ä–¥—ã ”©—à—ñ—Ä—É
            for (let [id, el] of myCardsMap) {
                if (!newIds.has(id)) {
                    // –ï–≥–µ—Ä –∫–∞—Ä—Ç–∞ “Ø—Å—Ç–µ–ª–≥–µ –∫–µ—Ç–ø–µ—Å–µ, –∂–∞–π ”©—à—ñ—Ä–µ–º—ñ–∑
                    if (!el.classList.contains('moving-to-table')) {
                        el.remove();
                    }
                    myCardsMap.delete(id);
                }
            }

            // –ë. –ñ–∞“£–∞ –∫–∞—Ä—Ç–∞–ª–∞—Ä–¥—ã “õ–æ—Å—É –∂”ô–Ω–µ –±–∞—Ä–ª—ã“ì—ã–Ω –æ—Ä–Ω–∞–ª–∞—Å—Ç—ã—Ä—É
            const total = sorted.length;
            const handRect = els.myHand.getBoundingClientRect();
            
            // –û—Ä—Ç–∞—Å—ã–Ω —Ç–∞–±—É
            const startX = handRect.width / 2;
            const startY = 100; // –¢”©–º–µ–Ω–Ω–µ–Ω

            sorted.forEach((card, i) => {
                const id = getCardId(card);
                let el = myCardsMap.get(id);

                // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—Ç–∞—Ä–¥—ã –µ—Å–µ–ø—Ç–µ—É (–í–µ–µ—Ä —ç—Ñ—Ñ–µ–∫—Ç—ñ—Å—ñ)
                const spread = 35; // –ö–∞—Ä—Ç–∞–ª–∞—Ä–¥—ã“£ –∞—Ä–∞“õ–∞—à—ã“õ—Ç—ã“ì—ã
                const angleSpread = 4; // –ë“±—Ä—ã–ª—É –≥—Ä–∞–¥—É—Å—ã
                
                const offset = i - (total - 1) / 2;
                const x = startX + (offset * spread) - 45; // 45 = –∫–∞—Ä—Ç–∞ –µ–Ω—ñ–Ω—ñ“£ –∂–∞—Ä—Ç—ã—Å—ã
                const y = Math.abs(offset) * 8; 
                const rot = offset * angleSpread;

                if (!el) {
                    // –ñ–ê“¢–ê –ö–ê–†–¢–ê!
                    el = document.createElement('div');
                    el.className = 'card my-card';
                    el.innerHTML = getCardHTML(card);
                    el.id = id;
                    
                    // 1. –ë–∞—Å—Ç–∞–ø“õ—ã –Ω“Ø–∫—Ç–µ—Å—ñ (–ö–æ–ª–æ–¥–∞–¥–∞–Ω —à—ã“ì–∞–¥—ã)
                    const deckRect = els.deckCount.getBoundingClientRect();
                    el.style.left = deckRect.left + 'px';
                    el.style.top = deckRect.top + 'px';
                    el.style.transform = 'rotate(0deg) scale(0.5)';
                    
                    els.myHand.appendChild(el);
                    myCardsMap.set(id, el);
                    
                    // –°“Ø–π—Ä–µ—É –ª–æ–≥–∏–∫–∞—Å—ã–Ω “õ–æ—Å—É
                    addDragLogic(el, i, card);

                    // 2. –°”ô–ª –∫–µ—à—ñ–≥—ñ–ø “õ–æ–ª“ì–∞ “±—à–∞–¥—ã (–ê–Ω–∏–º–∞—Ü–∏—è —ñ—Å—Ç–µ—É “Ø—à—ñ–Ω)
                    requestAnimationFrame(() => {
                        el.style.left = x + 'px';
                        el.style.top = y + 'px';
                        el.style.transform = `rotate(${rot}deg)`;
                    });
                } else {
                    // –ë“∞–†–´–ù–ù–ê–ù –ë–ê–† –ö–ê–†–¢–ê (–∂–∞–π “ì–∞–Ω–∞ —Å—ã—Ä“ì–∏–¥—ã)
                    if (!el.classList.contains('dragging')) {
                        el.style.left = x + 'px';
                        el.style.top = y + 'px';
                        el.style.transform = `rotate(${rot}deg)`;
                        // –°“Ø–π—Ä–µ—É –∏–Ω–¥–µ–∫—Å—ñ–Ω –∂–∞“£–∞—Ä—Ç—É
                        el.dataset.index = i; 
                        el.dataset.baseX = x;
                        el.dataset.baseY = y;
                        el.dataset.baseRot = rot;
                    }
                }
            });
        }

        // 3. “Æ–°–¢–ï–õ–î–Ü –ñ–ê“¢–ê–†–¢–£ (–ö—ñ—à—ñ—Ä–µ–π—Ç—É –∂”ô–Ω–µ –æ—Ä–Ω–∞–ª–∞—Å—Ç—ã—Ä—É)
        function updateTable(tablePairs) {
            const tableRect = els.table.getBoundingClientRect();
            // “Æ—Å—Ç–µ–ª–¥—ñ —Ç–∞–∑–∞–ª–∞—É–¥—ã“£ –æ—Ä–Ω—ã–Ω–∞, ID –∞—Ä“õ—ã–ª—ã —Ç–µ–∫—Å–µ—Ä–µ–º—ñ–∑
            // “ö–∞—Ä–∞–ø–∞–π—ã–º –±–æ–ª—É “Ø—à—ñ–Ω: ”ô—Ä –∂–∞“£–∞—Ä—Ç—É–¥–∞ —Ç–∞–∑–∞–ª–∞–π–º—ã–∑, –±—ñ—Ä–∞“õ CSS scale –±–∞—Ä
            els.table.innerHTML = ''; 

            let xOffset = -((tablePairs.length - 1) * 60) / 2; 

            tablePairs.forEach(pair => {
                // –®–∞–±—É—ã–ª –∫–∞—Ä—Ç–∞—Å—ã
                const atk = document.createElement('div');
                atk.className = 'card on-table';
                atk.innerHTML = getCardHTML(pair.card);
                atk.style.position = 'relative'; // Relative, —Å–µ–±–µ–±—ñ flex “õ–æ–ª–¥–∞–Ω–∞–º—ã–∑
                atk.style.margin = '0 10px';
                atk.style.transform = `rotate(${Math.random() * 10 - 5}deg) scale(0.75)`;
                
                // “ö–æ—Ä“ì–∞–Ω—ã—Å –∫–∞—Ä—Ç–∞—Å—ã
                if (pair.defendedBy) {
                    const def = document.createElement('div');
                    def.className = 'card on-table';
                    def.innerHTML = getCardHTML(pair.defendedBy);
                    def.style.position = 'absolute';
                    def.style.left = '15px';
                    def.style.top = '15px';
                    def.style.zIndex = 2;
                    def.style.transform = `rotate(${Math.random() * 10 + 5}deg) scale(0.75)`;
                    atk.appendChild(def);
                }
                els.table.appendChild(atk);
            });
        }

        // 4. –°“Æ–ô–†–ï–£ –õ–û–ì–ò–ö–ê–°–´ (DRAG & DROP)
        function addDragLogic(el, index, cardObj) {
            let isDragging = false;
            let startX, startY;

            el.addEventListener('touchstart', (e) => {
                isDragging = false;
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
            }, {passive: false});

            el.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const dx = touch.clientX - startX;
                const dy = touch.clientY - startY;

                // –ï–≥–µ—Ä —Å”ô–ª “õ–æ–∑“ì–∞–ª—Å–∞, —Å“Ø–π—Ä–µ—É –±–∞—Å—Ç–∞–ª–¥—ã
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) isDragging = true;

                if (isDragging) {
                    el.classList.add('dragging');
                    // –°–∞—É—Å–∞“õ–ø–µ–Ω –±—ñ—Ä–≥–µ –∂“Ø—Ä—É
                    el.style.transform = `translate(${dx}px, ${dy}px) scale(1.1) rotate(0deg)`;
                }
            }, {passive: false});

            el.addEventListener('touchend', (e) => {
                el.classList.remove('dragging');
                
                if (isDragging) {
                    const touch = e.changedTouches[0];
                    const tableRect = els.table.getBoundingClientRect();

                    // –ï–≥–µ—Ä “Ø—Å—Ç–µ–ª–≥–µ —Ç–∞—Å—Ç–∞–ª—Å–∞
                    if (touch.clientY < tableRect.bottom && touch.clientY > tableRect.top) {
                        // –°–µ—Ä–≤–µ—Ä–≥–µ –∂—ñ–±–µ—Ä—É
                        socket.emit('playCard', parseInt(el.dataset.index || index));
                        
                        // "–§—É–∫ –µ—Ç—ñ–ø –∂–æ“õ –±–æ–ª—É" –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è—Å—ã (–°–µ—Ä–≤–µ—Ä –∂–∞—É–∞–ø –±–µ—Ä–≥–µ–Ω—à–µ)
                        el.style.opacity = '0';
                        el.style.transform = 'scale(0.5)';
                    } else {
                        // –û—Ä–Ω—ã–Ω–∞ “õ–∞–π—Ç—É
                        resetCardPosition(el);
                    }
                } else {
                    // –ñ–∞–π –±–∞—Å—É (Tap) - –û—Ä–Ω—ã–Ω–∞ “õ–∞–π—Ç—É
                    resetCardPosition(el);
                }
                isDragging = false;
            });
        }

        function resetCardPosition(el) {
            el.style.transform = `rotate(${el.dataset.baseRot}deg)`;
            el.style.left = el.dataset.baseX + 'px';
            el.style.top = el.dataset.baseY + 'px';
        }

        // SOCKET EVENTS
        socket.on('updateState', (state) => {
            // –ö–æ–∑—ã—Ä—å
            if (state.trumpCard) {
                els.trump.innerHTML = getCardHTML(state.trumpCard);
            }
            els.deckCount.innerText = state.deckCount;
            
            // –°—Ç–∞—Ç—É—Å
            if (state.winner) {
                showStatus(state.winner === 'player' ? "–ñ–ï“¢–Ü–°! üòé" : "–ñ–ï“¢–Ü–õ–Ü–° üò¢");
            } else {
                els.gameInfo.innerText = state.attacker === 'player' ? "–°—ñ–∑–¥—ñ“£ –∂“Ø—Ä—ñ—Å" : "–ë–æ—Ç—Ç—ã“£ –∂“Ø—Ä—ñ—Å—ñ";
                els.gameInfo.style.color = state.attacker === 'player' ? "#4cd137" : "#ff4757";
            }

            // “ö–æ–ª–¥—ã –∂”ô–Ω–µ “Ø—Å—Ç–µ–ª–¥—ñ –∂–∞“£–∞—Ä—Ç—É
            updateMyHand(state.playerHand, state.trumpCard ? state.trumpCard.suit : '');
            updateTable(state.table);
            
            // –ë–æ—Ç—Ç—ã“£ “õ–æ–ª—ã–Ω –∂–∞“£–∞—Ä—Ç—É (–∂–∞–π “ì–∞–Ω–∞ —Å–∞–Ω—ã)
            els.botArea.innerHTML = '';
            for(let i=0; i<state.botCardCount; i++) {
                const bCard = document.createElement('div');
                bCard.className = 'card card-back';
                bCard.style.position = 'absolute';
                bCard.style.left = (50 + i * 10) + '%';
                bCard.style.top = '10px';
                bCard.style.transform = 'translateX(-50%) scale(0.6)';
                els.botArea.appendChild(bCard);
            }
        });

        function takeAction() { socket.emit('actionTake'); }
        function bitaAction() { socket.emit('actionBita'); }

        function showStatus(text) {
            els.status.innerText = text;
            els.status.style.display = 'block';
            setTimeout(() => els.status.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
